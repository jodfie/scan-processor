{% extends "base.html" %}

{% block title %}Prompts Editor - Scan Processor{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div>
        <h2 class="text-3xl font-bold text-white">Claude Code Prompts</h2>
        <p class="mt-2 text-gray-400">View and edit classification and metadata extraction prompts</p>
    </div>

    <!-- Info Banner -->
    <div class="bg-blue-900 bg-opacity-20 border border-blue-700 rounded-lg p-4">
        <div class="flex items-start">
            <svg class="w-6 h-6 text-blue-400 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div class="text-sm text-blue-200">
                <p class="font-semibold mb-1">About Prompts</p>
                <p>These prompts are sent to Claude Code to classify documents and extract metadata. Changes take effect immediately for new documents. A backup is created before each save.</p>
            </div>
        </div>
    </div>

    <!-- Prompt Tabs -->
    <div class="bg-gray-800 rounded-lg border border-gray-700">
        <!-- Tab Headers -->
        <div class="border-b border-gray-700">
            <nav class="flex space-x-2 p-2" role="tablist">
                {% for key, prompt in prompts.items() %}
                <button
                    onclick="switchTab('{{ prompt.name }}')"
                    id="tab-{{ prompt.name }}"
                    class="px-4 py-2 rounded text-sm font-medium transition-colors tab-button {% if loop.first %}bg-gray-700 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-700{% endif %}"
                    role="tab">
                    {{ prompt.display_name }}
                </button>
                {% endfor %}
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="p-6">
            {% for key, prompt in prompts.items() %}
            <div id="content-{{ prompt.name }}" class="tab-content {% if not loop.first %}hidden{% endif %}">
                {% if prompt.exists %}
                <div class="space-y-4">
                    <!-- Editor Header -->
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-white">{{ prompt.display_name }} Prompt</h3>
                            <p class="text-sm text-gray-400 mt-1">{{ prompt.path }}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="resetPrompt('{{ prompt.name }}')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded transition-colors text-sm">
                                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Reset
                            </button>
                            <button onclick="savePrompt('{{ prompt.name }}')" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors text-sm">
                                <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                                </svg>
                                Save
                            </button>
                        </div>
                    </div>

                    <!-- Editor -->
                    <textarea
                        id="editor-{{ prompt.name }}"
                        class="w-full h-96 px-4 py-3 bg-gray-900 border border-gray-700 rounded text-gray-300 text-sm font-mono resize-y focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Loading prompt..."></textarea>

                    <!-- Character Count -->
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span id="charcount-{{ prompt.name }}">0 characters</span>
                        <span id="save-status-{{ prompt.name }}"></span>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p class="mt-2 text-lg font-medium text-gray-400">Prompt file not found</p>
                    <p class="mt-1 text-sm text-gray-500">{{ prompt.path }}</p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Success/Error Toast -->
<div id="toast" class="hidden fixed bottom-4 right-4 bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-4 max-w-sm z-50">
    <div class="flex items-start">
        <div id="toast-icon" class="flex-shrink-0"></div>
        <div class="ml-3">
            <p id="toast-message" class="text-sm font-medium text-white"></p>
        </div>
        <button onclick="closeToast()" class="ml-4 flex-shrink-0 text-gray-400 hover:text-white">
            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let promptData = {};
    let currentTab = '{{ prompts.keys() | list | first }}';

    // Load all prompts on page load
    document.addEventListener('DOMContentLoaded', function() {
        {% for key, prompt in prompts.items() %}
        {% if prompt.exists %}
        loadPrompt('{{ prompt.name }}');
        {% endif %}
        {% endfor %}
    });

    function switchTab(name) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });

        // Deactivate all tab buttons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('bg-gray-700', 'text-white');
            btn.classList.add('text-gray-400');
        });

        // Show selected tab
        document.getElementById('content-' + name).classList.remove('hidden');

        // Activate selected button
        const btn = document.getElementById('tab-' + name);
        btn.classList.add('bg-gray-700', 'text-white');
        btn.classList.remove('text-gray-400');

        currentTab = name;
    }

    function loadPrompt(name) {
        fetch(`/api/prompts/${name}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    promptData[name] = data.content;
                    const editor = document.getElementById('editor-' + name);
                    if (editor) {
                        editor.value = data.content;
                        updateCharCount(name);

                        // Add input listener for char count
                        editor.addEventListener('input', () => updateCharCount(name));
                    }
                } else {
                    showToast('error', 'Failed to load prompt: ' + data.error);
                }
            })
            .catch(error => {
                showToast('error', 'Error loading prompt: ' + error);
            });
    }

    function savePrompt(name) {
        const editor = document.getElementById('editor-' + name);
        const content = editor.value;

        if (!content.trim()) {
            showToast('error', 'Prompt cannot be empty');
            return;
        }

        const statusEl = document.getElementById('save-status-' + name);
        statusEl.textContent = 'Saving...';
        statusEl.className = 'text-yellow-400';

        fetch(`/api/prompts/${name}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content: content })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                promptData[name] = content;
                statusEl.textContent = '✓ Saved';
                statusEl.className = 'text-green-400';
                showToast('success', 'Prompt saved successfully! Backup created.');
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 3000);
            } else {
                statusEl.textContent = '✗ Failed';
                statusEl.className = 'text-red-400';
                showToast('error', 'Failed to save: ' + data.error);
            }
        })
        .catch(error => {
            statusEl.textContent = '✗ Error';
            statusEl.className = 'text-red-400';
            showToast('error', 'Error saving prompt: ' + error);
        });
    }

    function resetPrompt(name) {
        if (!promptData[name]) {
            showToast('error', 'Original prompt not loaded');
            return;
        }

        if (!confirm('Reset prompt to last saved version? Any unsaved changes will be lost.')) {
            return;
        }

        const editor = document.getElementById('editor-' + name);
        editor.value = promptData[name];
        updateCharCount(name);
        showToast('info', 'Prompt reset to last saved version');
    }

    function updateCharCount(name) {
        const editor = document.getElementById('editor-' + name);
        const charCount = document.getElementById('charcount-' + name);
        if (editor && charCount) {
            const count = editor.value.length;
            charCount.textContent = `${count.toLocaleString()} characters`;
        }
    }

    function showToast(type, message) {
        const toast = document.getElementById('toast');
        const icon = document.getElementById('toast-icon');
        const msg = document.getElementById('toast-message');

        const icons = {
            success: '<svg class="h-6 w-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
            error: '<svg class="h-6 w-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
            info: '<svg class="h-6 w-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
        };

        icon.innerHTML = icons[type] || icons.info;
        msg.textContent = message;

        toast.classList.remove('hidden');

        setTimeout(() => {
            closeToast();
        }, 5000);
    }

    function closeToast() {
        document.getElementById('toast').classList.add('hidden');
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+S to save current tab
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            savePrompt(currentTab);
        }
    });
</script>
{% endblock %}
